% Copyright 2017 Beckman Coulter, Inc.
%
% Permission is hereby granted, free of charge, to any person
% obtaining a copy of this software and associated documentation files
% (the "Software"), to deal in the Software without restriction,
% including without limitation the rights to use, copy, modify, merge,
% publish, distribute, sublicense, and/or sell copies of the Software,
% and to permit persons to whom the Software is furnished to do so,
% subject to the following conditions:
%
% The above copyright notice and this permission notice shall be
% included in all copies or substantial portions of the Software.
%
% THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
% EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
% MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
% NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
% BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
% ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
% CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
% SOFTWARE.

\chapter {System Statistics}\label{chap:stats}

\section {Introduction}

The system uses a single gen-server named \code{statistics} to
periodically query statistics about the system, such as memory usage.

\section {Theory of Operation}

When the \code{statistics} gen-server starts, it posts a
\code{<statistics>} event with \code{reason} = \code{startup}.
Every five minutes thereafter, it posts a \code{<statistics>} event
with \code{reason} = \code{update}. If the computer sleeps or
hibernates, the gen-server posts a \code{<statistics>} event with
\code{reason} = \code{suspend}. When the computer awakens, the
gen-server posts a \code{<statistics>} event with \code{reason} =
\code{resume}. When the gen-server terminates, it posts a
\code{<statistics>} event with \code{reason} = \code{shutdown}.

The \code{<statistics>} event is handled by the \code{log-db}
gen-server (see Chapter~\ref{chap:log-db}), which adds the data to the
statistics table in the log database.

\section {Programming Interface}

\defineentry{statistics:start\&link}
\begin{procedure}
  \code{(statistics:start\&link)}
\end{procedure}
\returns{}
\code{\#(ok \var{pid})} $|$
\code{\#(error \var{error})}

The \code{statistics:start\&link} procedure creates a new gen-server
named \code{statistics} using \code{gen-server:start\&link}. It
then posts a \code{<statistics>} event with \code{reason} =
\code{startup}.

\defineentry{statistics:resume}
\begin{procedure}
  \code{(statistics:resume)}
\end{procedure}

The \code{statistics:resume} procedure casts a message to the
\code{statistics} gen-server that causes it to publish a
\code{<statistics>} event with \code{reason} =
\code{resume}. This procedure is aliased to \code{app:resume} and
called from the operating system interface.

\defineentry{statistics:suspend}
\begin{procedure}
  \code{(statistics:suspend)}
\end{procedure}

The \code{statistics:suspend} procedure casts a message to the
\code{statistics} gen-server that causes it to publish a
\code{<statistics>} event with \code{reason} = \code{suspend}.
This procedure is aliased to \code{app:suspend} and called from the
operating system interface.

\section {Published Events}

\begin{pubevent}{<statistics>}
  \argrow{timestamp}{timestamp from \code{erlang:now}}
  \argrow{date}{date from \code{current-date}}
  \argrow{reason}{\code{startup}, \code{update}, \code{suspend},
    \code{resume}, or \code{shutdown}}
  \argrow{bytes-allocated}{Scheme heap size from \code{bytes-allocated}}
  \argrow{osi-bytes-used}{C++ heap size from \code{osi::GetBytesUsed}}
  \argrow{sqlite-memory}{SQLite memory used from \code{osi::GetSQLiteStatus}}
  \argrow{sqlite-memory-highwater}{SQLite memory highwater since
    last event from \code{osi::GetSQLiteStatus}}
  \argrow{ports}{number of open ports from \code{osi::GetHandleCounts}}
  \argrow{processes}{number of open processes from \code{osi::GetHandleCounts}}
  \argrow{databases}{number of open SQLite databases from \code{osi::GetHandleCounts}}
  \argrow{statements}{number of open SQLite statements from \code{osi::GetHandleCounts}}
  \argrow{listeners}{number of open TCP/IP listeners from \code{osi::GetHandleCounts}}
  \argrow{working-set-size}{working set size from \code{osi::GetMemoryInfo}}
  \argrow{pagefile-usage}{pagefile usage from \code{osi::GetMemoryInfo}}
  \argrow{private-usage}{private usage from \code{osi::GetMemoryInfo}}
  \argrow{cpu}{CPU time in seconds since last event}
  \argrow{real}{elapsed time in seconds since last event}
  \argrow{bytes}{Scheme heap bytes allocated since last event}
  \argrow{gc-count}{number of garbage collections since last event}
  \argrow{gc-cpu}{CPU time in seconds of garbage collections since
    last event}
  \argrow{gc-real}{elapsed time in seconds of garbage collections
    since last event}
  \argrow{gc-bytes}{Scheme heap bytes reclaimed since last event}
\end{pubevent}

This event is sent every five minutes while the \code{statistics}
gen-server is running.
